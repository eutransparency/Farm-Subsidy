{% extends "base.html" %}
{% load humanize markup %}

{% block title %}
  {{ recipient.name }} | {{ country.name }}
{% endblock %}

{% block page_title %}
  {{ recipient.name }}
{% endblock %}


{% block content %}
  
  <div class="section">
    <h3>Recipient Information</h3>
    <div class="halfcolleft">
    <h4>Address</h4>

    {% if recipient.address1 %}{{ recipient.address1|title }}<br />{% endif %}
    {% if recipient.address2 %}{{ recipient.address2|title }}<br />{% endif %}
    {% if recipient.address3 %}{{ recipient.address3|title }}<br />{% endif %}
    {% if recipient.town %}{{ recipient.town|title }}<br />{% endif %}
    {% if recipient.address4 %}{{ recipient.address4|title }}<br />{% endif %}
    {% if recipient.zipcode %}{{ recipient.zipcode|slice:"3:" }}<br />{% endif %}    
    </div>

    <div class="halfcolleft">
    <h4>Location</h4>
    {% if recipient.geo4 %}{{ recipient.geo4|title }}<br />{% endif %}
    {% if recipient.geo3 %}{{ recipient.geo3|title }}<br />{% endif %}
    {% if recipient.geo2 %}{{ recipient.geo2|title }}<br />{% endif %}
    {% if recipient.geo1 %}{{ recipient.geo1|title }}<br />{% endif %}
    </div>
    <div class="clear"></div>
  </div>
  

  {# Only show the graph if there is more than one payment_year #}
  {% if payment_years.1 %}
    {% load graphs %}
    {% graph "recipient_graph" recipient.globalrecipientidx %}
  {% endif %}
  <div class="section">  
    <h3>Payments</h3>
  <table>
    <thead>
      <th>Year</th>
      <th>Scheme</th>
      <th>Total</th>
    </thead>
    {% for payment in payments %}
      <tr>
        <td>{{ payment.year }} </td>
        <td>
          {# {% if payment.schemeid %} #}
            {# <a href="{% url scheme_view payment.country payment.schemeid %}">{{ payment.scheme.name }}</a> #}
          {# {% else %} #}
            {{ payment.scheme.nameenglish }}
          {# {% endif %} #}
        </td>
        <td>&euro;{{ payment.amounteuro|floatformat:2|intcomma }}</td>
      </tr>
    {% endfor %}
    <tr>
      <td></td>
      <td style="text-align:right;"><strong>Total:</strong></td>
      <td>&euro;{{ recipient_total|floatformat:2|intcomma }}</td>
    </tr>
  </table>
  </div>
  {% load more_like_this %}
  {# {% more_like_this recipient as related_content for "data.recipient" limit 2 %} #}
  {% more_like_this recipient as related_content limit 3 %}
  {% if related_content %}
    <div class="section">
      <h3>Related</h3>
      <p>The following recipients might be related to {{ recipient.name }}</p>
      <ul>
      {% for item in related_content %}
        <li><a href="{{ item.object.get_absolute_url }}">{{ item.object.name }}</a></li>
      {% endfor %}
      </ul>
    
    </div>
  {% endif %}

  <div class="section">
    {% load comments i18n %}
    {% get_comment_list for recipient as comment_list %}
    {% for comment in comment_list %}
      <div class="comment">
        <div class="info col">        
          <h4>{{ comment.user }}</h4>
          {{ comment.submit_date|date:"H.i" }} {{ comment.submit_date|naturalday }}
        </div>    
        <div class="message col">
          {{ comment.comment|markdown:"safe" }}
        </div>
      </div>
    {% endfor %}
    
  </div>

  <div class="section">
    <h3>Add information for this recipient</h3>
    <p>e.g. What kind of farm or company is it? Is it a subsidiary of another company? Are you the owner or do you live nearby? Any other factual information to add?</p>
    
    {% if user.is_authenticated %}
    {% get_comment_form for recipient as form %}
    <form action="{% comment_form_target %}" method="post">
      {% if next %}<input type="hidden" name="next" value="{{ next }}" />{% endif %}
      {% for field in form %}
        {% if field.is_hidden %}
          {{ field }}
        {% else %}
          {% if field.errors %}{{ field.errors }}{% endif %}
          <p
            {% if field.errors %} class="error"{% endif %}
            {% ifequal field.name "honeypot" %} style="display:none;"{% endifequal %}>
            {{ field.label_tag }} {{ field }}

          </p>
        {% endif %}
      {% endfor %}
      <p class="submit">
        <input type="submit" name="post" class="submit-post" value="{% trans "Post" %}" />
        <input type="submit" name="preview" class="submit-preview" value="{% trans "Preview" %}" />
      </p>
    </form>
    
    {% else %}
        <a href="{% url registration_register %}">Create an account</a> or <a href="{% url auth_login %}">Log in</a> to add information.
    {% endif %}
  </div>
  
{% endblock %}


{% block right %}

{% include "breadcrumbs.html" %}

{% load recipient_blocks %}  
{% recipient_links recipient %}

{% endblock %}